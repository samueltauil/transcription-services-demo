# GitHub Actions workflow for deploying Static Web App (Frontend)
name: 3. Deploy Static Web App

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main
    paths:
      - 'frontend/**'
  workflow_dispatch:
    inputs:
      resourceGroup:
        description: 'Azure Resource Group (for auto-config)'
        required: false
        default: 'speech-demo-west'

env:
  AZURE_RESOURCE_GROUP: ${{ github.event.inputs.resourceGroup || 'speech-demo-west' }}

jobs:
  build-and-deploy:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Build and Deploy
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Validate deployment token
        run: |
          if [ -z "${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}" ]; then
            echo "âŒ Error: AZURE_STATIC_WEB_APPS_API_TOKEN secret is not set!"
            echo ""
            echo "To get the deployment token:"
            echo "1. Go to Azure Portal â†’ Static Web Apps â†’ Your App"
            echo "2. Click 'Manage deployment token'"
            echo "3. Copy the token and add it as a GitHub secret"
            exit 1
          fi
          echo "âœ“ Deployment token found"

      - name: Login to Azure (optional - for auto-config)
        uses: azure/login@v2
        continue-on-error: true
        id: azure-login
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Auto-configure API URL
        if: steps.azure-login.outcome == 'success'
        run: |
          # Get Function App name from Azure
          FUNC_NAME=$(az functionapp list -g ${{ env.AZURE_RESOURCE_GROUP }} --query "[0].name" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$FUNC_NAME" ]; then
            echo "âœ“ Found Function App: $FUNC_NAME"
            
            # Update staticwebapp.config.json
            sed -i "s|\"[^\"]*\.azurewebsites\.net\"|\"${FUNC_NAME}.azurewebsites.net\"|g" frontend/staticwebapp.config.json
            
            # Update app.js fallback URL
            sed -i "s|return 'https://[^']*\.azurewebsites\.net/api'|return 'https://${FUNC_NAME}.azurewebsites.net/api'|g" frontend/app.js
            
            echo "âœ“ Frontend configured for: https://${FUNC_NAME}.azurewebsites.net/api"
          else
            echo "âš ï¸ Could not find Function App - using existing configuration"
          fi

      - name: Build and Deploy to Azure Static Web Apps
        id: builddeploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/frontend"
          output_location: ""
          skip_api_build: true

      - name: Output summary
        run: |
          echo "## Static Web App Deployed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The frontend has been deployed successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check your Static Web App URL in the Azure Portal." >> $GITHUB_STEP_SUMMARY

  close-pull-request:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request
    
    steps:
      - name: Close Pull Request
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: "close"
