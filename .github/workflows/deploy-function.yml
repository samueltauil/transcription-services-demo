# GitHub Actions workflow for deploying Azure Function App
# Uses remote build for Python dependencies
name: 2. Deploy Azure Functions

on:
  push:
    branches:
      - main
    paths:
      - 'function_app.py'
      - 'requirements.txt'
      - 'host.json'
      - '.github/workflows/deploy-function.yml'
  workflow_dispatch:
    inputs:
      functionAppName:
        description: 'Function App name (leave empty to use secret)'
        required: false
      resourceGroup:
        description: 'Resource Group name'
        required: false
        default: 'speech-demo-west'

env:
  PYTHON_VERSION: '3.11'
  RESOURCE_GROUP: ${{ github.event.inputs.resourceGroup || 'speech-demo-west' }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set Function App Name
        id: set-name
        run: |
          if [ -n "${{ github.event.inputs.functionAppName }}" ]; then
            echo "name=${{ github.event.inputs.functionAppName }}" >> $GITHUB_OUTPUT
          else
            echo "name=${{ secrets.AZURE_FUNCTIONAPP_NAME }}" >> $GITHUB_OUTPUT
          fi

      - name: Validate Function App Name
        run: |
          if [ -z "${{ steps.set-name.outputs.name }}" ]; then
            echo "âŒ Error: Function App name not set!"
            echo "Please either:"
            echo "  1. Set AZURE_FUNCTIONAPP_NAME as a repository secret"
            echo "  2. Or provide functionAppName when triggering workflow manually"
            exit 1
          fi
          echo "âœ“ Using Function App: ${{ steps.set-name.outputs.name }}"

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies to packages folder
        run: |
          pip install --upgrade pip
          mkdir -p .python_packages/lib/site-packages
          pip install -r requirements.txt --target=".python_packages/lib/site-packages"

      - name: Create deployment package
        run: |
          zip -r deploy.zip \
            function_app.py \
            host.json \
            requirements.txt \
            .python_packages \
            -x "*.pyc" \
            -x "*__pycache__*" \
            -x "*.dist-info/*"
          echo "Package size: $(ls -lh deploy.zip | awk '{print $5}')"

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ steps.set-name.outputs.name }}
          package: deploy.zip
          scm-do-build-during-deployment: false
          enable-oryx-build: false

      - name: Restart function app
        run: |
          FUNC_NAME="${{ steps.set-name.outputs.name }}"
          echo "ðŸ”„ Restarting function app..."
          sleep 30
          az functionapp restart --name $FUNC_NAME --resource-group ${{ env.RESOURCE_GROUP }}
          sleep 30

      - name: Verify deployment
        run: |
          FUNC_NAME="${{ steps.set-name.outputs.name }}"
          echo "ðŸ” Verifying deployment..."
          
          # Test health endpoint
          HEALTH_URL="https://$FUNC_NAME.azurewebsites.net/api/health"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
          
          if [ "$HTTP_CODE" -eq "200" ]; then
            echo "âœ… Health check passed!"
          else
            echo "âš ï¸ Health check returned: $HTTP_CODE (may still be starting)"
          fi
          
          # List functions
          echo ""
          echo "ðŸ“‹ Deployed functions:"
          az functionapp function list --name $FUNC_NAME --resource-group ${{ env.RESOURCE_GROUP }} -o table || echo "Loading..."

      - name: Output summary
        run: |
          FUNC_NAME="${{ steps.set-name.outputs.name }}"
          echo "## Function App Deployed! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Function App:** \`$FUNC_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** https://$FUNC_NAME.azurewebsites.net/api/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Endpoints:" >> $GITHUB_STEP_SUMMARY
          echo "- Health: \`/api/health\`" >> $GITHUB_STEP_SUMMARY
          echo "- Upload: \`/api/upload\`" >> $GITHUB_STEP_SUMMARY
          echo "- Status: \`/api/status/{job_id}\`" >> $GITHUB_STEP_SUMMARY
